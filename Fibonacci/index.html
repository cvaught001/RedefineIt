<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Fibonacci Shell ‚Äî Canvas Controls</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root { color-scheme: dark; }
      html, body { margin: 0; height: 100%; background: #0b0f13; overflow: hidden; }
      canvas { display: block; width: 100vw; height: 100vh; }
      #toggleUi {
        position: fixed; right: 8px; top: 8px; z-index: 3;
        width: 36px; height: 36px; border-radius: 10px;
        display: inline-flex; align-items: center; justify-content: center;
        background: rgba(12,20,16,0.6); color: #d8f5df;
        border: 1px solid rgba(150,220,180,0.3); cursor: pointer;
        box-shadow: 0 2px 10px rgba(0,0,0,0.25);
      }
      #toggleUi:active { transform: translateY(1px); }
      #toggleInfo {
        position: fixed; right: 52px; top: 8px; z-index: 3;
        width: 36px; height: 36px; border-radius: 10px;
        display: inline-flex; align-items: center; justify-content: center;
        background: rgba(12,20,16,0.6); color: #d8f5df;
        border: 1px solid rgba(150,220,180,0.3); cursor: pointer;
        box-shadow: 0 2px 10px rgba(0,0,0,0.25);
      }
      #toggleInfo:active { transform: translateY(1px); }
      .ui {
        position: fixed; left: 12px; top: 12px; z-index: 2;
        font: 14px/1.35 system-ui, -apple-system, Segoe UI, sans-serif;
        color: #d8f5df; background: rgba(10,15,20,0.55);
        backdrop-filter: blur(6px);
        border: 1px solid rgba(140,200,160,0.25);
        border-radius: 12px; padding: 12px; width: 330px; max-height: 92vh; overflow: auto;
      }
      .row { display: flex; align-items: center; gap: 8px; margin: 8px 0; }
      .row label { flex: 1 1 auto; }
      .row input[type="range"] { width: 140px; }
      .row input[type="color"] { width: 40px; height: 24px; padding: 0; border: none; background: transparent; }
      small { opacity: 0.8; }
      .hr { border: 0; height: 1px; background: rgba(160,220,170,0.25); margin: 10px 0; }
      .btn { padding: 6px 10px; border-radius: 8px; border: 1px solid rgba(150,220,180,0.3); background: rgba(12,20,16,0.6); color: #d8f5df; cursor: pointer; }
      .btn:active { transform: translateY(1px); }
    </style>
  </head>
  <body>
    <canvas id="c"></canvas>
    <button id="toggleUi" title="Show/Hide options" aria-label="Show/Hide options">üëÅ</button>
    <button id="toggleInfo" title="Show Info" aria-label="Show Info">‚ìò</button>
    <!-- Optional external preset; if present, adds "User Preset" -->
    <script src="preset.js"></script>

    <div class="ui">
      <strong style="display:block;margin-bottom:6px;">Fibonacci Shell (Log Spiral)</strong>

      <div class="row">
        <label>Turns <small id="turnsV"></small></label>
        <input id="turns" type="range" min="0.5" max="7" step="0.05" value="4" />
      </div>
      <div class="row">
        <label>Growth / Turn <small id="growV"></small></label>
        <input id="growth" type="range" min="1.10" max="2.60" step="0.01" value="1.618" />
      </div>
      <div class="row">
        <label>Base Radius <small id="baseRV"></small></label>
        <input id="baseR" type="range" min="10" max="300" step="1" value="60" />
      </div>
      <div class="row">
        <label>Thickness (%) <small id="thickV"></small></label>
        <input id="thick" type="range" min="5" max="80" step="1" value="35" />
      </div>
      <div class="row">
        <label>Rotation (¬∞) <small id="rotV"></small></label>
        <input id="rot" type="range" min="0" max="360" step="1" value="0" />
      </div>

      <div class="row">
        <label>Center X (%) <small id="cxV"></small></label>
        <input id="cx" type="range" min="0" max="100" step="1" value="50" />
      </div>
      <div class="row">
        <label>Center Y (%) <small id="cyV"></small></label>
        <input id="cy" type="range" min="0" max="100" step="1" value="60" />
      </div>

      <div class="row">
        <label>Samples / Turn <small id="sampV"></small></label>
        <input id="samp" type="range" min="48" max="360" step="1" value="180" />
      </div>

      <div class="hr"></div>

      <div class="row">
        <label>Outline (px) <small id="olwV"></small></label>
        <input id="olw" type="range" min="0" max="4" step="0.1" value="1" />
      </div>
      <div class="row">
        <label>Outline Color</label>
        <input id="olc" type="color" value="#fbecc8" />
      </div>
      <div class="row">
        <label>Fill Alpha (%) <small id="faV"></small></label>
        <input id="fillA" type="range" min="0" max="100" step="1" value="85" />
      </div>
      <div class="row">
        <label>Base Hue <small id="h0V"></small></label>
        <input id="h0" type="range" min="0" max="360" step="1" value="130" />
      </div>
      <div class="row">
        <label>Hue Delta <small id="hDV"></small></label>
        <input id="hD" type="range" min="-180" max="180" step="1" value="-45" />
      </div>
      <div class="row">
        <label>Saturation (%) <small id="satV"></small></label>
        <input id="sat" type="range" min="0" max="100" step="1" value="60" />
      </div>
      <div class="row">
        <label>Lightness (%) <small id="litV"></small></label>
        <input id="lit" type="range" min="0" max="100" step="1" value="55" />
      </div>

      <div class="row">
        <label>Transparent BG</label>
        <input id="tbg" type="checkbox" />
      </div>
      <div class="row">
        <label>BG Color</label>
        <input id="bgc" type="color" value="#0b0f13" />
      </div>

      <div class="hr"></div>

      <!-- Presets + JSON import/export -->
      <div class="row">
        <label>Preset</label>
        <select id="presetSelect" style="flex:1 1 auto">
          <option value="default">Default</option>
          <option value="golden">Golden Spiral</option>
          <option value="thin">Thin Shell</option>
          <option value="thick">Thick Shell</option>
          <option value="ringsOff">No Rings</option>
          <option value="perspective">Perspective</option>
          <option value="custom">Custom</option>
        </select>
      </div>
      <div class="row">
        <button id="saveJson" class="btn">üíæ Export JSON</button>
        <button id="loadJson" class="btn">üìÇ Import JSON</button>
      </div>

      <div class="hr"></div>

      <div class="row">
        <label>Rings</label>
        <input id="ringsOn" type="checkbox" checked />
      </div>
      <div class="row">
        <label>Ring Count <small id="ringCV"></small></label>
        <input id="ringC" type="range" min="0" max="120" step="1" value="40" />
      </div>
      <div class="row">
        <label>Ring Alpha (%) <small id="ringAV"></small></label>
        <input id="ringA" type="range" min="0" max="50" step="1" value="12" />
      </div>

      <div class="hr"></div>

      <div class="row">
        <label>Perspective</label>
        <input id="perspOn" type="checkbox" />
      </div>
      <div class="row">
        <label>Foreshortening <small id="perspV"></small></label>
        <input id="persp" type="range" min="0" max="100" step="1" value="40" />
      </div>

      <div class="hr"></div>
      <div class="row">
        <label>Spin</label>
        <input id="spinOn" type="checkbox" checked />
      </div>
      <div class="row">
        <label>Spin Speed (¬∞/s) <small id="spinV"></small></label>
        <input id="spin" type="range" min="-360" max="360" step="1" value="60" />
      </div>
      <div class="row">
        <label>Evolve (turns/s) <small id="evoV"></small></label>
        <input id="evo" type="range" min="0" max="2" step="0.01" value="0.20" />
      </div>

      <div class="hr"></div>

      <div class="row">
        <label>Chambers</label>
        <input id="chOn" type="checkbox" checked />
      </div>
      <div class="row">
        <label>Chamber Steps <small id="chStepsV"></small></label>
        <input id="chSteps" type="range" min="1" max="64" step="1" value="16" />
      </div>
      <div class="row">
        <label>Label Fibonacci</label>
        <input id="chLabels" type="checkbox" checked />
      </div>

      <div class="row">
        <label>Spiral Dividers <small id="divV"></small></label>
        <input id="dividers" type="range" min="0" max="8" step="1" value="0" />
      </div>
      <div class="row">
        <label>Spiral Hatching <small id="hatV"></small></label>
        <input id="hatch" type="range" min="0" max="12" step="1" value="0" />
      </div>

      <div class="hr"></div>
      <div class="row">
        <button id="reset" class="btn">Reset</button>
        <button id="export" class="btn">Export PNG</button>
        <button id="infoBtn" class="btn" title="Info">‚ìò Info</button>
      </div>
      <small>Tip: Growth per turn ‚âà œÜ (1.618) for golden shells. Toggle Spin + Evolve for animation.</small>
    </div>

    <!-- Info overlay -->
    <div id="overlay" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.55);z-index:9;">
      <div id="modal" style="background:rgba(12,18,22,0.95);color:#e7f6ee;border:1px solid rgba(140,200,160,0.35);border-radius:12px;max-width:800px;width:86vw;max-height:80vh;box-shadow:0 10px 40px rgba(0,0,0,0.6);">
        <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid rgba(140,200,160,0.25)">
          <strong>Info (log.md)</strong>
          <button id="closeOverlay" class="btn" style="padding:4px 8px;">‚úï</button>
        </div>
        <div style="padding:12px;overflow:auto;max-height:68vh;">
          <pre id="logContent" style="margin:0;white-space:pre-wrap;word-break:break-word;font:13px/1.4 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;"></pre>
        </div>
      </div>
    </div>

    <script>
      ;(() => {
        const canvas = document.getElementById('c')
        const ctx = canvas.getContext('2d')

        // UI refs
        const $ = id => document.getElementById(id)
        const $turns = $('turns'), $turnsV = $('turnsV')
        const $growth = $('growth'), $growV = $('growV')
        const $baseR = $('baseR'), $baseRV = $('baseRV')
        const $thick = $('thick'), $thickV = $('thickV')
        const $rot = $('rot'), $rotV = $('rotV')
        const $cx = $('cx'), $cxV = $('cxV')
        const $cy = $('cy'), $cyV = $('cyV')
        const $samp = $('samp'), $sampV = $('sampV')
        const $olw = $('olw'), $olwV = $('olwV')
        const $olc = $('olc')
        const $fillA = $('fillA'), $faV = $('faV')
        const $h0 = $('h0'), $h0V = $('h0V')
        const $hD = $('hD'), $hDV = $('hDV')
        const $sat = $('sat'), $satV = $('satV')
        const $lit = $('lit'), $litV = $('litV')
        const $tbg = $('tbg'), $bgc = $('bgc')
        const $ringsOn = $('ringsOn'), $ringC = $('ringC'), $ringCV = $('ringCV'), $ringA = $('ringA'), $ringAV = $('ringAV')
        const $perspOn = $('perspOn'), $persp = $('persp'), $perspV = $('perspV')
        const $spinOn = $('spinOn'), $spin = $('spin'), $spinV = $('spinV')
        const $evo = $('evo'), $evoV = $('evoV')
        const $chOn = $('chOn'), $chSteps = $('chSteps'), $chStepsV = $('chStepsV'), $chLabels = $('chLabels')
        const $dividers = $('dividers'), $divV = $('divV')
        const $hatch = $('hatch'), $hatV = $('hatV')
        const $reset = $('reset'), $export = $('export')
        const $infoBtn = $('infoBtn')
        const $overlay = $('overlay')
        const $closeOverlay = $('closeOverlay')
        const $logContent = $('logContent')
        const $presetSelect = $('presetSelect')
        const $saveJson = $('saveJson')
        const $loadJson = $('loadJson')
        const $toggleUi = $('toggleUi')
        const $toggleInfo = $('toggleInfo')
        const $uiBox = document.querySelector('.ui')

        // Canvas DPI scaling
        const dpi = () => window.devicePixelRatio || 1
        function resize() {
          const d = dpi()
          canvas.width = Math.floor(innerWidth * d)
          canvas.height = Math.floor(innerHeight * d)
          ctx.setTransform(d, 0, 0, d, 0, 0)
        }
        addEventListener('resize', () => { resize(); render() })
        resize()

        // Helpers
        const clamp = (x, a, b) => Math.max(a, Math.min(b, x))
        const deg = a => (a * Math.PI) / 180
        const hsla = (h,s,l,a) => `hsla(${(h%360+360)%360} ${s}% ${l}% / ${a})`

        // Animation state
        let spinRad = 0
        let turnsCurr = Number($turns.value)
        let lastT = performance.now()

        function getOpts() {
          $turnsV.textContent = Number($turns.value).toFixed(2)
          $growV.textContent = Number($growth.value).toFixed(3)
          $baseRV.textContent = Number($baseR.value)
          $thickV.textContent = Number($thick.value) + '%'
          $rotV.textContent = Number($rot.value) + '¬∞'
          $cxV.textContent = Number($cx.value) + '%'
          $cyV.textContent = Number($cy.value) + '%'
          $sampV.textContent = Number($samp.value)
          $olwV.textContent = Number($olw.value).toFixed(1)
          $faV.textContent = Number($fillA.value) + '%'
          $h0V.textContent = Number($h0.value)
          $hDV.textContent = Number($hD.value)
          $satV.textContent = Number($sat.value) + '%'
          $litV.textContent = Number($lit.value) + '%'
          $ringCV.textContent = Number($ringC.value)
          $ringAV.textContent = Number($ringA.value) + '%'
          $perspV.textContent = Number($persp.value)
          $spinV.textContent = Number($spin.value)
          $evoV.textContent = Number($evo.value)
          $chStepsV.textContent = Number($chSteps.value)
          $divV.textContent = Number($dividers.value)
          $hatV.textContent = Number($hatch.value)

          return {
            turns: turnsCurr,
            growth: Number($growth.value),
            baseR: Number($baseR.value),
            thickPct: Number($thick.value) / 100,
            rot: deg(Number($rot.value)) + spinRad,
            cxPct: Number($cx.value) / 100,
            cyPct: Number($cy.value) / 100,
            sampPerTurn: Number($samp.value),
            outlineW: Number($olw.value),
            outlineC: $olc.value,
            fillAlpha: Number($fillA.value) / 100,
            h0: Number($h0.value),
            hD: Number($hD.value),
            sat: Number($sat.value),
            lit: Number($lit.value),
            tbg: $tbg.checked,
            bgc: $bgc.value,
            ringsOn: $ringsOn.checked,
            ringCount: Number($ringC.value),
            ringAlpha: Number($ringA.value) / 100,
            perspOn: $perspOn.checked,
            persp: Number($persp.value) / 100,
            chOn: $chOn.checked,
            chSteps: Number($chSteps.value),
            chLabels: $chLabels.checked
            ,
            dividers: Number($dividers.value),
            hatch: Number($hatch.value)
          }
        }

        function projectorFactory(W,H, on, k) {
          if (!on || k <= 0) return null
          const ax = W * 0.5, ay = H * 0.85
          return (x, y) => {
            const depth = clamp((ay - y) / Math.max(60, H * 0.9), 0, 1)
            const f = 1 / (1 + k * 2 * depth)
            const xp = ax + (x - ax) * f
            const yp = ay + (y - ay) * f
            return [xp, yp]
          }
        }

        function buildShellPoints(opts, W, H) {
          const {
            turns, growth, baseR, thickPct, rot, cxPct, cyPct, sampPerTurn,
            perspOn, persp
          } = opts
          const totalTheta = Math.max(0.001, turns) * Math.PI * 2
          const b = Math.log(Math.max(1.0001, growth)) / (Math.PI * 2)
          const cx = W * cxPct, cy = H * cyPct
          const S = Math.max(12, Math.floor(sampPerTurn * turns))
          const P = projectorFactory(W,H, perspOn, persp)

          const outer = new Array(S+1)
          const inner = new Array(S+1)
          let rMax = 0
          for (let i = 0; i <= S; i++) {
            const t = (i / S) * totalTheta
            const r = baseR * Math.exp(b * t)
            const ri = r * (1 - thickPct)
            const ang = t + rot
            let xo = cx + r * Math.cos(ang)
            let yo = cy + r * Math.sin(ang)
            let xi = cx + ri * Math.cos(ang)
            let yi = cy + ri * Math.sin(ang)
            if (P) {
              ;[xo, yo] = P(xo, yo)
              ;[xi, yi] = P(xi, yi)
            }
            outer[i] = [xo, yo]
            inner[i] = [xi, yi]
            if (r > rMax) rMax = r
          }
          return { outer, inner, cx, cy, rMax }
        }

        function fib(n){ let a=0,b=1; const out=[]; for(let i=0;i<n;i++){out.push(b); [a,b]=[b,a+b]} return out }

        function drawChambers(ctx, opts, cx, cy) {
          if (!opts.chOn || opts.chSteps <= 0) return
          const W = innerWidth, H = innerHeight
          const totalTheta = Math.max(0.001, opts.turns) * Math.PI * 2
          const b = Math.log(Math.max(1.0001, opts.growth)) / (Math.PI * 2)
          const P = projectorFactory(W,H, opts.perspOn, opts.persp)
          const N = opts.chSteps
          const thick = opts.thickPct
          const fseq = fib(N+2)
          ctx.save()
          ctx.globalAlpha = 0.25
          for (let k=0;k<N;k++){
            const t0 = (k / N) * totalTheta
            const t1 = ((k+1) / N) * totalTheta
            const S = 36
            const outer=[]; const inner=[]
            for (let i=0;i<=S;i++){
              const t = t0 + (i/S)*(t1-t0)
              const r = opts.baseR * Math.exp(b*t)
              const ri = r * (1 - thick)
              const ang = t + opts.rot
              let xo = cx + r * Math.cos(ang), yo = cy + r * Math.sin(ang)
              let xi = cx + ri * Math.cos(ang), yi = cy + ri * Math.sin(ang)
              if (P){ [xo,yo]=P(xo,yo); [xi,yi]=P(xi,yi) }
              outer.push([xo,yo]); inner.push([xi,yi])
            }
            ctx.beginPath()
            ctx.moveTo(outer[0][0], outer[0][1])
            for(let i=1;i<outer.length;i++) ctx.lineTo(outer[i][0], outer[i][1])
            for(let i=inner.length-1;i>=0;i--) ctx.lineTo(inner[i][0], inner[i][1])
            ctx.closePath()
            const hue = (opts.h0 + (opts.hD*(k/N)))
            ctx.fillStyle = hsla(hue, opts.sat, opts.lit, 0.25)
            ctx.fill()
            if (opts.chLabels){
              const tm = (t0+t1)/2
              const rm = opts.baseR * Math.exp(b*tm) * (1 - thick*0.5)
              let x = cx + rm * Math.cos(tm + opts.rot)
              let y = cy + rm * Math.sin(tm + opts.rot)
              if (P){ [x,y]=P(x,y) }
              ctx.fillStyle = 'rgba(240,255,245,0.9)'
              ctx.font = '12px system-ui, sans-serif'
              ctx.textAlign = 'center'
              ctx.textBaseline = 'middle'
              const label = fseq[k] || (k+1)
              ctx.fillText(String(label), x, y)
            }

            // Spiral dividers (M lines evenly spaced across shell thickness)
            const M = Math.max(0, Math.min(8, Math.floor(opts.dividers || 0)))
            if (M > 0){
              ctx.save()
              ctx.globalAlpha = 0.6
              ctx.strokeStyle = 'rgba(235,250,245,0.8)'
              ctx.lineWidth = Math.max(0.6, opts.outlineW * 0.7)
              for (let m=1; m<=M; m++){
                const f = m / (M+1) // 0..1 fraction from inner->outer
                const s = (1 - thick) + thick * f
                ctx.beginPath()
                for (let i=0;i<=S;i++){
                  const t = t0 + (i/S)*(t1-t0)
                  const r = opts.baseR * s * Math.exp(b*t)
                  const ang = t + opts.rot
                  let x = cx + r * Math.cos(ang)
                  let y = cy + r * Math.sin(ang)
                  if (P){ [x,y]=P(x,y) }
                  if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y)
                }
                ctx.stroke()
              }
              ctx.restore()
            }

            // Spiral hatching (H faint lines, 0 disables)
            const Hc = Math.max(0, Math.min(12, Math.floor(opts.hatch || 0)))
            if (Hc > 0){
              ctx.save()
              ctx.globalAlpha = 0.18
              ctx.strokeStyle = 'rgba(230,245,240,0.9)'
              ctx.lineWidth = Math.max(0.4, opts.outlineW * 0.5)
              for (let h=1; h<=Hc; h++){
                const f = h / (Hc+1)
                const s = (1 - thick) + thick * f
                ctx.beginPath()
                for (let i=0;i<=S;i++){
                  const t = t0 + (i/S)*(t1-t0)
                  const r = opts.baseR * s * Math.exp(b*t)
                  const ang = t + opts.rot
                  let x = cx + r * Math.cos(ang)
                  let y = cy + r * Math.sin(ang)
                  if (P){ [x,y]=P(x,y) }
                  if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y)
                }
                ctx.stroke()
              }
              ctx.restore()
            }
          }
          ctx.restore()
        }

        function drawShell(ctx, opts) {
          const W = innerWidth, H = innerHeight
          ctx.clearRect(0, 0, W, H)

          if (!opts.tbg) {
            ctx.fillStyle = opts.bgc
            ctx.fillRect(0, 0, W, H)
          }

          const { outer, inner, cx, cy, rMax } = buildShellPoints(opts, W, H)

          const g = ctx.createRadialGradient(cx, cy, 0, cx, cy, Math.max(60, rMax))
          g.addColorStop(0, hsla(opts.h0, opts.sat, opts.lit, opts.fillAlpha))
          g.addColorStop(1, hsla(opts.h0 + opts.hD, opts.sat, Math.max(0, opts.lit - 12), Math.max(0, opts.fillAlpha - 0.15)))

          ctx.beginPath()
          ctx.moveTo(outer[0][0], outer[0][1])
          for (let i = 1; i < outer.length; i++) ctx.lineTo(outer[i][0], outer[i][1])
          for (let i = inner.length - 1; i >= 0; i--) ctx.lineTo(inner[i][0], inner[i][1])
          ctx.closePath()

          ctx.fillStyle = g
          ctx.fill()
          if (opts.outlineW > 0) {
            ctx.strokeStyle = opts.outlineC
            ctx.lineWidth = opts.outlineW
            ctx.stroke()
          }

          drawChambers(ctx, opts, cx, cy)

          if (opts.ringsOn && opts.ringCount > 0) {
            ctx.save()
            ctx.strokeStyle = `rgba(230,240,235,${opts.ringAlpha})`
            ctx.lineWidth = Math.max(0.5, opts.outlineW * 0.7)
            const totalTheta = Math.max(0.001, opts.turns) * Math.PI * 2
            const b = Math.log(Math.max(1.0001, opts.growth)) / (Math.PI * 2)
            const P = projectorFactory(W,H, opts.perspOn, opts.persp)
            for (let j = 1; j <= opts.ringCount; j++) {
              const t = (j / opts.ringCount) * totalTheta
              const r = opts.baseR * Math.exp(b * t)
              const segs = 120
              ctx.beginPath()
              for (let k = 0; k <= segs; k++) {
                const a = opts.rot + (k / segs) * Math.PI * 2
                let x = cx + r * Math.cos(a)
                let y = cy + r * Math.sin(a)
                if (P) [x, y] = P(x, y)
                if (k === 0) ctx.moveTo(x, y)
                else ctx.lineTo(x, y)
              }
              ctx.closePath()
              ctx.stroke()
            }
            ctx.restore()
          }
        }

        function render() { drawShell(ctx, getOpts()) }

        // Animation
        function tick(t){
          const dt = (t - lastT) / 1000
          lastT = t
          if ($spinOn.checked){
            const degPerSec = Number($spin.value)
            spinRad += (degPerSec * Math.PI/180) * dt
          }
          const evoRate = Number($evo.value)
          if (evoRate > 0){
            turnsCurr = Math.max(0.1, turnsCurr + evoRate * dt)
          } else {
            turnsCurr = Number($turns.value)
          }
          render()
          requestAnimationFrame(tick)
        }

        // Wire up
        const inputs = [
          $turns,$growth,$baseR,$thick,$rot,$cx,$cy,$samp,
          $olw,$olc,$fillA,$h0,$hD,$sat,$lit,$tbg,$bgc,
          $ringsOn,$ringC,$ringA,$perspOn,$persp,
          $spinOn,$spin,$evo,$chOn,$chSteps,$chLabels,
          $dividers,$hatch
        ]
        inputs.forEach(el => el && el.addEventListener('input', () => {
          if ($presetSelect && $presetSelect.value !== 'custom') $presetSelect.value = 'custom'
          render()
        }))
        $turns.addEventListener('input', () => { turnsCurr = Number($turns.value) })

        $reset.addEventListener('click', () => {
          $turns.value = 4
          $growth.value = 1.618
          $baseR.value = 60
          $thick.value = 35
          $rot.value = 0
          $cx.value = 50
          $cy.value = 60
          $samp.value = 180
          $olw.value = 1
          $olc.value = '#fbecc8'
          $fillA.value = 85
          $h0.value = 130
          $hD.value = -45
          $sat.value = 60
          $lit.value = 55
          $tbg.checked = false
          $bgc.value = '#0b0f13'
          $ringsOn.checked = true
          $ringC.value = 40
          $ringA.value = 12
          $perspOn.checked = false
          $persp.value = 40
          $spinOn.checked = false
          $spin.value = 60
          $evo.value = 0.20
          $chOn.checked = false
          $chSteps.value = 16
          $chLabels.checked = true
          spinRad = 0
          turnsCurr = Number($turns.value)
          render()
        })

        $export.addEventListener('click', () => {
          const link = document.createElement('a')
          link.download = 'fibonacci-shell.png'
          link.href = canvas.toDataURL('image/png')
          link.click()
        })

        // Eye toggle ‚Äî show/hide options panel
        function setUiVisible(v) {
          if (!$uiBox) return
          $uiBox.style.display = v ? 'block' : 'none'
          $toggleUi.textContent = v ? 'üôà' : 'üëÅ'
          localStorage.setItem('fib_ui_visible', v ? '1' : '0')
        }
        const uiVisiblePref = localStorage.getItem('fib_ui_visible')
        setUiVisible(uiVisiblePref !== '0')
        $toggleUi.addEventListener('click', () => {
          const isVisible = $uiBox && $uiBox.style.display !== 'none'
          setUiVisible(!isVisible)
        })

        // Info toggle ‚Äî open/close log.md overlay
        $toggleInfo.addEventListener('click', () => {
          if ($overlay && $overlay.style.display === 'flex') {
            $overlay.style.display = 'none'
          } else {
            openInfo()
          }
        })

        // Presets + JSON
        const defaultPreset = {
          turns: 4,
          growth: 1.618,
          baseR: 60,
          thick: 35,
          rot: 0,
          cx: 50,
          cy: 60,
          samp: 180,
          olw: 1,
          olc: '#fbecc8',
          fillA: 85,
          h0: 130,
          hD: -45,
          sat: 60,
          lit: 55,
          tbg: false,
          bgc: '#0b0f13',
          ringsOn: true,
          ringC: 40,
          ringA: 12,
          perspOn: false,
          persp: 40,
          spinOn: false,
          spin: 60,
          evo: 0.2,
          chOn: false,
          chSteps: 16,
          chLabels: true,
          dividers: 0,
          hatch: 0
        }

        const presets = {
          default: defaultPreset,
          golden: { ...defaultPreset, growth: 1.618, h0: 40, hD: 60, sat: 70, lit: 58 },
          thin: { ...defaultPreset, thick: 15, ringC: 64, ringA: 8, fillA: 70 },
          thick: { ...defaultPreset, thick: 60, baseR: 40, ringC: 24, ringA: 16 },
          ringsOff: { ...defaultPreset, ringsOn: false },
          perspective: { ...defaultPreset, perspOn: true, persp: 70, cy: 65 }
        }

        // If an external preset is provided (via Fibonacci/preset.js), register it
        if (window.FIB_USER_PRESET && typeof window.FIB_USER_PRESET === 'object') {
          presets.user = { ...defaultPreset, ...window.FIB_USER_PRESET }
          // Add to dropdown before "custom"
          if ($presetSelect) {
            const opt = document.createElement('option')
            opt.value = 'user'
            opt.textContent = 'User Preset'
            const customOpt = Array.from($presetSelect.options).find(o => o.value === 'custom')
            if (customOpt) $presetSelect.add(opt, customOpt)
            else $presetSelect.appendChild(opt)
          }
        }

        function addPresetOption(key, label) {
          if (!$presetSelect) return
          if (Array.from($presetSelect.options).some(o => o.value === key)) return
          const opt = document.createElement('option')
          opt.value = key
          opt.textContent = label
          const customOpt = Array.from($presetSelect.options).find(o => o.value === 'custom')
          if (customOpt) $presetSelect.add(opt, customOpt)
          else $presetSelect.appendChild(opt)
        }

        // Load additional presets from presets.json if present
        ;(async function loadJsonPresets(){
          try {
            const res = await fetch('presets.json', { cache: 'no-store' })
            if (!res.ok) return
            const data = await res.json()
            let list = []
            if (Array.isArray(data)) list = data
            else if (Array.isArray(data.presets)) list = data.presets
            else if (data && typeof data === 'object') {
              list = Object.keys(data).map(k => ({ name: k, settings: data[k] }))
            }
            let selectedKey = null
            list.forEach(item => {
              const key = 'json_' + String(item.name || 'preset')
                .toLowerCase().replace(/[^a-z0-9]+/g, '_')
              presets[key] = { ...defaultPreset, ...(item.settings || {}) }
              addPresetOption(key, item.name || key)
              if ((item.name || '').toLowerCase().includes('perspective ‚Äî user') || (item.name || '').toLowerCase().includes('perspective - user')) {
                selectedKey = key
              }
            })
            // If a "Perspective ‚Äî User" JSON preset exists, select it by default
            if (selectedKey) {
              applySettings(presets[selectedKey])
              if ($presetSelect) $presetSelect.value = selectedKey
            }
          } catch (e) {
            // ignore if not available (e.g., local file open)
          }
        })()

        function getSettings() {
          return {
            turns: Number($turns.value),
            growth: Number($growth.value),
            baseR: Number($baseR.value),
            thick: Number($thick.value),
            rot: Number($rot.value),
            cx: Number($cx.value),
            cy: Number($cy.value),
            samp: Number($samp.value),
            olw: Number($olw.value),
            olc: String($olc.value),
            fillA: Number($fillA.value),
            h0: Number($h0.value),
            hD: Number($hD.value),
            sat: Number($sat.value),
            lit: Number($lit.value),
            tbg: Boolean($tbg.checked),
            bgc: String($bgc.value),
            ringsOn: Boolean($ringsOn.checked),
            ringC: Number($ringC.value),
            ringA: Number($ringA.value),
            perspOn: Boolean($perspOn.checked),
            persp: Number($persp.value),
            spinOn: Boolean($spinOn.checked),
            spin: Number($spin.value),
            evo: Number($evo.value),
            chOn: Boolean($chOn.checked),
            chSteps: Number($chSteps.value),
            chLabels: Boolean($chLabels.checked),
            dividers: Number($dividers.value),
            hatch: Number($hatch.value)
          }
        }

        function applySettings(s) {
          if (!s) return
          if (typeof s.turns === 'number') $turns.value = s.turns
          if (typeof s.growth === 'number') $growth.value = s.growth
          if (typeof s.baseR === 'number') $baseR.value = s.baseR
          if (typeof s.thick === 'number') $thick.value = s.thick
          if (typeof s.rot === 'number') $rot.value = s.rot
          if (typeof s.cx === 'number') $cx.value = s.cx
          if (typeof s.cy === 'number') $cy.value = s.cy
          if (typeof s.samp === 'number') $samp.value = s.samp
          if (typeof s.olw === 'number') $olw.value = s.olw
          if (typeof s.olc === 'string') $olc.value = s.olc
          if (typeof s.fillA === 'number') $fillA.value = s.fillA
          if (typeof s.h0 === 'number') $h0.value = s.h0
          if (typeof s.hD === 'number') $hD.value = s.hD
          if (typeof s.sat === 'number') $sat.value = s.sat
          if (typeof s.lit === 'number') $lit.value = s.lit
          if (typeof s.tbg === 'boolean') $tbg.checked = s.tbg
          if (typeof s.bgc === 'string') $bgc.value = s.bgc
          if (typeof s.ringsOn === 'boolean') $ringsOn.checked = s.ringsOn
          if (typeof s.ringC === 'number') $ringC.value = s.ringC
          if (typeof s.ringA === 'number') $ringA.value = s.ringA
          if (typeof s.perspOn === 'boolean') $perspOn.checked = s.perspOn
          if (typeof s.persp === 'number') $persp.value = s.persp
          if (typeof s.spinOn === 'boolean') $spinOn.checked = s.spinOn
          if (typeof s.spin === 'number') $spin.value = s.spin
          if (typeof s.evo === 'number') $evo.value = s.evo
          if (typeof s.chOn === 'boolean') $chOn.checked = s.chOn
          if (typeof s.chSteps === 'number') $chSteps.value = s.chSteps
          if (typeof s.chLabels === 'boolean') $chLabels.checked = s.chLabels
          if (typeof s.dividers === 'number') $dividers.value = s.dividers
          if (typeof s.hatch === 'number') $hatch.value = s.hatch
          turnsCurr = Number($turns.value)
          render()
        }

        // Init preset select and wire up
        $presetSelect.addEventListener('change', () => {
          const key = $presetSelect.value
          if (key === 'custom') return
          const p = presets[key]
          if (p) applySettings(p)
        })

        $saveJson.addEventListener('click', () => {
          const json = JSON.stringify(getSettings(), null, 2)
          // Try clipboard first; fallback to prompt
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(json).then(
              () => alert('Settings JSON copied to clipboard'),
              () => prompt('Copy settings JSON:', json)
            )
          } else {
            prompt('Copy settings JSON:', json)
          }
        })

        $loadJson.addEventListener('click', async () => {
          const text = prompt('Paste settings JSON:')
          if (!text) return
          try {
            const obj = JSON.parse(text)
            applySettings(obj)
            $presetSelect.value = 'custom'
          } catch (e) {
            alert('Invalid JSON')
          }
        })

        // Info Overlay: load ./log.md if present
        async function openInfo() {
          $logContent.textContent = 'Loading log.md...'
          $overlay.style.display = 'flex'
          try {
            const res = await fetch('log.md', { cache: 'no-store' })
            if (!res.ok) throw new Error('Missing log.md')
            const text = await res.text()
            $logContent.textContent = text
          } catch (err) {
            $logContent.textContent = 'No log.md found next to this file. Create fern/log.md to show content.'
          }
        }
        $infoBtn.addEventListener('click', openInfo)
        $closeOverlay.addEventListener('click', () => ($overlay.style.display = 'none'))
        $overlay.addEventListener('click', e => { if (e.target === $overlay) $overlay.style.display = 'none' })

        render()
        requestAnimationFrame(tick)
      })()
    </script>
  </body>
  </html>
