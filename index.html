<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Evolve Nine Bounce</title>
<style>
  body { margin:0; background:#111; overflow:hidden; color:#fff; font-family:sans-serif; }
  canvas { display:block; background:#222; touch-action:none; }
  #score { position:absolute; top:10px; left:10px; font-size:24px; color:cyan; }
  #lives { position:absolute; top:10px; right:10px; font-size:24px; color:red; }
  #shieldCount { position:absolute; top:40px; right:10px; font-size:18px; color:lime; }
  #instructions { position:absolute; bottom:10px; left:50%; transform:translateX(-50%); font-size:16px; color:lightblue; text-align:center; }
  #shieldBtn, #thrustBtn {
    position:absolute; bottom:70px; padding:15px 20px;
    font-size:18px; border:none; border-radius:10px; opacity:0.7;
  }
  #shieldBtn { right:20px; background:lime; color:#000; }
  #thrustBtn { left:20px; background:cyan; color:#000; }
</style>
</head>
<body>
<div id="score">Score:0</div>
<div id="lives">❤❤❤</div>
<div id="shieldCount">Shields:3</div>
<div id="instructions">
Use Arrow Keys / Thrust Button to Move | Space to Shoot | E / Shield Button to Activate Shield
</div>
<button id="shieldBtn">Shield</button>
<button id="thrustBtn">Thrust</button>
<canvas id="canvas"></canvas>
<script>
const canvas=document.getElementById('canvas'),ctx=canvas.getContext('2d');
const scoreEl=document.getElementById('score'),livesEl=document.getElementById('lives'),shieldEl=document.getElementById('shieldCount');
const shieldBtn=document.getElementById('shieldBtn'),thrustBtn=document.getElementById('thrustBtn');

function resize(){canvas.width=innerWidth;canvas.height=innerHeight;}
window.addEventListener('resize',resize);resize();

// ---------- Config / Performance ----------
const MAX_PARTICLES = 1400;        // hard cap for FPS
const PARTICLE_TRIM_BATCH = 200;   // trim in chunks to avoid frequent splice churn
const STAR_POINTS = 6;             // unified star point count
const SHIELD_RADIUS = 60;

// ---------- State ----------
const keys={},bullets=[],blobs=[],particles=[],dusts=[],predatorBlobs=[],shieldPowerUps=[],shieldFragments=[];
let score=0,lives=3,invulnerable=false,lastHitTime=0;
let ship={x:canvas.width/2,y:canvas.height/2,angle:0,radius:15,speed:0,maxSpeed:5,friction:0.95};
let shieldActive=false,shieldUses=3,shieldTimer=0,initialShield=true,initialShieldTimer=600;
let thrusting=false, shieldFlickerTimer=0;

// ---------- Input ----------
document.addEventListener('keydown',e=>{keys[e.code]=true;if(e.code==='Space')shoot();if(e.code==='KeyE')activateShield();});
document.addEventListener('keyup',e=>keys[e.code]=false);
shieldBtn.addEventListener('touchstart',activateShield,{passive:true});
shieldBtn.addEventListener('mousedown',activateShield);
thrustBtn.addEventListener('touchstart',()=>thrusting=true,{passive:true});
thrustBtn.addEventListener('touchend',()=>thrusting=false,{passive:true});
thrustBtn.addEventListener('mousedown',()=>thrusting=true);
thrustBtn.addEventListener('mouseup',()=>thrusting=false);

// Mobile rotate + double tap shoot
let lastTouch=0,startX=0;
canvas.addEventListener('touchstart',e=>{
  const t=Date.now();
  if(t-lastTouch<300)shoot();
  lastTouch=t;
  startX=e.touches[0].clientX;
},{passive:true});
canvas.addEventListener('touchmove',e=>{
  const dx=e.touches[0].clientX-startX;
  ship.angle+=dx*0.005;
  startX=e.touches[0].clientX;
},{passive:true});

// ---------- Utils ----------
const rnd = (a,b)=>Math.random()*(b-a)+a;
const dist = (a,b)=>Math.hypot(a.x-b.x,a.y-b.y);
function updateShieldDisplay(){shieldEl.textContent='Shields:'+shieldUses;}

// Dust
for(let i=0;i<100;i++) dusts.push({x:rnd(0,canvas.width),y:rnd(0,canvas.height),radius:rnd(1,3),alpha:rnd(0.1,0.5)});

// ---------- Blobs ----------
function createBlob(x,y,r,isPredator=false){
  return {
    x,y,vx:rnd(-1.5,1.5),vy:rnd(-1.5,1.5),
    radius:r,targetRadius:r,baseRadius:r,
    color:isPredator?'orange':`hsl(${rnd(180,220)},70%,50%)`,
    isPredator, hitCount:0,
    phaseOffsets:Array.from({length:20},()=>Math.random()*Math.PI*2),
    nuclei:[{radius:8,wobble:2,fillColor:'hsl(210,100%,25%)',strokeColor:'white',shapeFactor:1,phaseOffset:Math.random()*Math.PI*2,driftAngle:Math.random()*Math.PI*2,orbitRadius:5}],
    neonTimer:0
  };
}
for(let i=0;i<8;i++) blobs.push(createBlob(rnd(100,canvas.width-100),rnd(100,canvas.height-100),rnd(20,35)));
for(let i=0;i<3;i++) predatorBlobs.push(createBlob(rnd(100,canvas.width-100),rnd(100,canvas.height-100),40,true));

// ---------- Ship ----------
function drawShip(){
  ctx.save();
  ctx.translate(ship.x,ship.y);
  ctx.rotate(ship.angle);
  ctx.beginPath();
  ctx.moveTo(20,0);
  ctx.lineTo(-15,10);
  ctx.lineTo(-15,-10);
  ctx.closePath();
  ctx.strokeStyle='cyan';
  ctx.lineWidth=2;
  ctx.stroke();
  ctx.restore();
}

// Thruster
function createFireTriangle(x,y,vx,vy,color){
  pushParticle({x,y,vx,vy,life:28,color,shape:'triangle',size:rnd(4,6)});
}

// ---------- Bullets ----------
function shoot(){
  bullets.push({x:ship.x+Math.cos(ship.angle)*20,y:ship.y+Math.sin(ship.angle)*20,vx:Math.cos(ship.angle)*8,vy:Math.sin(ship.angle)*8});
}
function updateBullets(){
  for(let i=bullets.length-1;i>=0;i--){
    const b=bullets[i]; b.x+=b.vx; b.y+=b.vy;
    if(b.x<0||b.x>canvas.width||b.y<0||b.y>canvas.height) bullets.splice(i,1);
  }
}

// ---------- Blob update/draw ----------
function updateBlob(b){
  b.radius += (b.targetRadius-b.radius)*0.2;
  b.x+=b.vx; b.y+=b.vy;
  if(b.x-b.radius<0||b.x+b.radius>canvas.width) b.vx*=-1;
  if(b.y-b.radius<0||b.y+b.radius>canvas.height) b.vy*=-1;
}
function drawBlob(b, now){
  // undulating outline
  const pts=[], t = now*0.003;
  let radiusOffset=0; if(b.isPredator) radiusOffset=Math.sin(now*0.01)*5;
  for(let i=0;i<b.phaseOffsets.length;i++){
    const a=(i/b.phaseOffsets.length)*Math.PI*2;
    pts.push({
      x:b.x+(b.radius+radiusOffset+Math.sin(t+b.phaseOffsets[i])*3)*Math.cos(a),
      y:b.y+(b.radius+radiusOffset+Math.sin(t+b.phaseOffsets[i])*3)*Math.sin(a)
    });
  }
  ctx.beginPath();
  ctx.moveTo(pts[0].x,pts[0].y);
  for(let i=0;i<pts.length;i++){
    const p0=pts[i], p1=pts[(i+1)%pts.length];
    ctx.quadraticCurveTo(p0.x,p0.y,(p0.x+p1.x)/2,(p0.y+p1.y)/2);
  }
  ctx.closePath();

  if(!b.isPredator){
    ctx.fillStyle=b.color; ctx.globalAlpha=0.6; ctx.fill(); ctx.globalAlpha=1;
    ctx.strokeStyle='white'; ctx.lineWidth=2; ctx.shadowBlur=0; ctx.stroke();
  }else{
    // guardian neon rim (no hit flash)
    ctx.strokeStyle = 'orange';
    ctx.lineWidth=2; ctx.shadowBlur=10; ctx.shadowColor='orange';
    ctx.stroke();
  }

  // nucleus shimmer
  const n=b.nuclei[0]; n.driftAngle+=0.03;
  const ox=Math.cos(n.driftAngle)*n.orbitRadius, oy=Math.sin(n.driftAngle)*n.orbitRadius;
  const nr=n.radius+Math.sin(t+n.phaseOffset)*n.wobble;
  ctx.beginPath();
  ctx.ellipse(b.x+ox,b.y+oy,nr*n.shapeFactor,nr,0,0,Math.PI*2);
  ctx.fillStyle=n.fillColor; ctx.globalAlpha=0.85; ctx.fill(); ctx.globalAlpha=1;
  ctx.strokeStyle=n.strokeColor; ctx.lineWidth=1.2; ctx.stroke();
}

// ---------- Particles (optimized) ----------
function pushParticle(p){
  particles.push(p);
  if(particles.length>MAX_PARTICLES){
    particles.splice(0, Math.min(PARTICLE_TRIM_BATCH, particles.length - MAX_PARTICLES));
  }
}

function spawnExplosion(x,y,base='violet',count=36,sMin=1.5,sMax=5,life=60){
  const hueBase = base==='violet' ? 260 : null;
  for(let i=0;i<count;i++){
    const a=rnd(0,Math.PI*2), sp=rnd(sMin,sMax);
    const color = hueBase!==null ? `hsl(${hueBase+rnd(-16,16)},90%,60%)` : base;
    pushParticle({x,y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,life:life + ((Math.random()*20)|0)-10,color,shape: (Math.random()<0.75?'star':'triangle'), size:rnd(5,9)});
  }
}

function drawStarPath(x,y,size,rot,points=STAR_POINTS){
  const outer=size,inner=size*0.45;
  ctx.moveTo(x+Math.cos(rot)*outer,y+Math.sin(rot)*outer);
  for(let i=1;i<points*2;i++){
    const r=(i%2===0)?outer:inner;
    const a=rot+(i*Math.PI/points);
    ctx.lineTo(x+Math.cos(a)*r,y+Math.sin(a)*r);
  }
  ctx.closePath();
}

function updateParticles(){
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    p.x+=p.vx; p.y+=p.vy;
    p.vx*=0.965; p.vy*=0.965;
    p.life--;
    if(p.life<=0) particles.splice(i,1);
  }
}

function drawParticles(now){
  const rot = (now*0.01) % (Math.PI*2);
  for(let i=0;i<particles.length;i++){
    const p=particles[i];
    const a = Math.max(p.life/70, 0);
    ctx.globalAlpha = a;
    if(p.shape==='triangle'){
      ctx.beginPath();
      const ang=Math.atan2(p.vy,p.vx), s=p.size||5;
      ctx.moveTo(p.x+Math.cos(ang)*s, p.y+Math.sin(ang)*s);
      ctx.lineTo(p.x+Math.cos(ang+2.1)*s, p.y+Math.sin(ang+2.1)*s);
      ctx.lineTo(p.x+Math.cos(ang-2.1)*s, p.y+Math.sin(ang-2.1)*s);
      ctx.closePath();
      ctx.strokeStyle=p.color; ctx.lineWidth=1.3; ctx.stroke();
    } else { // star (default)
      ctx.beginPath();
      drawStarPath(p.x,p.y,p.size||6, rot + i*0.02);
      ctx.strokeStyle=p.color; ctx.lineWidth=1.2; ctx.stroke();
    }
  }
  ctx.globalAlpha=1;
}

// ---------- Shield ----------
function drawShield(now){
  const pulse = 0.5+0.5*Math.sin(now*0.05);
  const active = initialShield || shieldActive;
  const baseColor = initialShield ? 'red' : 'cyan';
  ctx.save();
  if(active){
    ctx.shadowColor = baseColor;
    ctx.shadowBlur = 12 + 14*pulse;
    ctx.globalAlpha = 0.7 + 0.3*pulse;
    ctx.strokeStyle = baseColor;
  }else{
    ctx.globalAlpha=0.2; ctx.shadowBlur=0; ctx.strokeStyle='cyan';
  }
  ctx.beginPath();
  for(let i=0;i<STAR_POINTS;i++){
    const a=-Math.PI/2+(i*2*Math.PI)/STAR_POINTS;
    const x=ship.x+SHIELD_RADIUS*Math.cos(a), y=ship.y+SHIELD_RADIUS*Math.sin(a);
    (i===0)?ctx.moveTo(x,y):ctx.lineTo(x,y);
  }
  ctx.closePath();
  ctx.lineWidth=2;
  ctx.stroke();
  ctx.restore();
}

// ---------- Ship explosion / respawn ----------
function shipExplosion(){
  for(let i=0;i<40;i++){
    pushParticle({x:ship.x,y:ship.y,vx:rnd(-3,3),vy:rnd(-3,3),life:30,color:Math.random()<0.5?'red':'yellow',shape:'triangle',size:rnd(4,7)});
  }
}
function shipRespawn(){
  const cx=canvas.width/2,cy=canvas.height/2;
  ship.x=ship.y=-1000;
  let flicker=0;
  const interval=setInterval(()=>{
    ctx.fillStyle=flicker%2===0?'#fff':'#222';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    flicker++;
    if(flicker>5){
      clearInterval(interval);
      ship.x=cx; ship.y=cy;
      invulnerable=true; lastHitTime=Date.now();
      for(let i=0;i<60;i++){
        const a=rnd(0,2*Math.PI), r=rnd(100,300);
        pushParticle({x:cx+Math.cos(a)*r,y:cy+Math.sin(a)*r,vx:-Math.cos(a)*rnd(2,6),vy:-Math.sin(a)*rnd(2,6),life:60,color:'cyan',shape:'triangle',size:rnd(4,7)});
      }
    }
  },50);
}
function updateLivesDisplay(){livesEl.textContent='';for(let i=0;i<lives;i++)livesEl.textContent+='❤';}

// ---------- Ship update ----------
function updateShip(now){
  if(keys['ArrowLeft']) ship.angle -=0.07;
  if(keys['ArrowRight']) ship.angle +=0.07;
  if(keys['ArrowUp']||thrusting){
    ship.speed=Math.min(ship.speed+0.2,ship.maxSpeed);
    const a=ship.angle+Math.PI;
    for(let i=0;i<2;i++){
      const s=rnd(1,3);
      createFireTriangle(ship.x-15*Math.cos(ship.angle),ship.y-15*Math.sin(ship.angle),Math.cos(a+rnd(-0.2,0.2))*s,Math.sin(a+rnd(-0.2,0.2))*s,'cyan');
    }
  }
  ship.x+=Math.cos(ship.angle)*ship.speed;
  ship.y+=Math.sin(ship.angle)*ship.speed;
  ship.speed*=ship.friction;

  if(ship.x<0) ship.x=canvas.width;
  if(ship.x>canvas.width) ship.x=0;
  if(ship.y<0) ship.y=canvas.height;
  if(ship.y>canvas.height) ship.y=0;

  if(invulnerable && (now-lastHitTime)>1000) invulnerable=false;
  if(shieldActive){ if(--shieldTimer<=0) shieldActive=false; }
  if(initialShield){ if(--initialShieldTimer<=0) initialShield=false; }
}

// ---------- Power-ups ----------
function updateShieldPowerUps(){
  for(const s of shieldPowerUps){
    s.x+=s.vx; s.y+=s.vy;
    if(s.x<0||s.x>canvas.width) s.vx*=-1;
    if(s.y<0||s.y>canvas.height) s.vy*=-1;
    s.life--;
  }
}
function drawShieldPowerUps(now){
  const t=now*0.005;
  for(let i=shieldPowerUps.length-1;i>=0;i--){
    const s=shieldPowerUps[i];
    if(s.life<=0){ shieldPowerUps.splice(i,1); continue; }
    const pulse=1+0.3*Math.sin(t*5+i);
    const alpha=0.7+0.3*Math.sin(t*5+i);
    ctx.beginPath();
    for(let j=0;j<STAR_POINTS;j++){
      const a=-Math.PI/2+(j*2*Math.PI)/STAR_POINTS;
      const x=s.x+s.radius*pulse*Math.cos(a), y=s.y+s.radius*pulse*Math.sin(a);
      (j===0)?ctx.moveTo(x,y):ctx.lineTo(x,y);
    }
    ctx.closePath();
    ctx.strokeStyle=`rgba(255,20,147,${alpha})`;
    ctx.lineWidth=3;
    ctx.shadowColor='magenta';
    ctx.shadowBlur=15;
    ctx.stroke();
  }
}
setInterval(()=>{
  if(shieldPowerUps.length<1)
    shieldPowerUps.push({ x:rnd(50,canvas.width-50), y:rnd(50,canvas.height-50), radius:20, life:600, vx:rnd(-0.3,0.3), vy:rnd(-0.3,0.3) });
},15000);

// ---------- Shield fragments ----------
function checkShieldPowerUpHits(){
  for(let i=shieldPowerUps.length-1;i>=0;i--){
    const s=shieldPowerUps[i];
    for(let j=bullets.length-1;j>=0;j--){
      const b=bullets[j];
      if(dist(s,b)<s.radius){
        bullets.splice(j,1);
        shieldUses++; updateShieldDisplay();
        // explode into fragments
        for(let k=0;k<30;k++){
          const a=rnd(0,2*Math.PI), sp=rnd(2,5);
          shieldFragments.push({x:s.x,y:s.y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,life:60,radius:5,color:'violet',shape:'star'});
        }
        shieldPowerUps.splice(i,1);
        break;
      }
    }
  }
}
function drawShieldFragments(now){
  const rot=(now*0.02)%(Math.PI*2);
  for(let i=shieldFragments.length-1;i>=0;i--){
    const f=shieldFragments[i];
    f.x+=f.vx; f.y+=f.vy; f.life--;
    if(f.life<=0){ shieldFragments.splice(i,1); continue; }

    ctx.beginPath();
    drawStarPath(f.x,f.y,f.radius,rot,STAR_POINTS);
    ctx.strokeStyle=f.color; ctx.lineWidth=2; ctx.stroke();

    // hits
    for(let j=blobs.length-1;j>=0;j--){
      const pb=blobs[j];
      if(dist(f,pb)<pb.radius+f.radius){
        spawnExplosion(pb.x,pb.y,'cyan',24,1,3,45);
        blobs.splice(j,1);
        f.life=0; score+=10; scoreEl.textContent='Score:'+score;
        break;
      }
    }
    for(let j=predatorBlobs.length-1;j>=0 && f.life>0;j--){
      const pr=predatorBlobs[j];
      if(dist(f,pr)<pr.radius+f.radius){
        spawnExplosion(pr.x,pr.y,'violet',48,2,6,70);
        predatorBlobs.splice(j,1);
        f.life=0; score+=25; scoreEl.textContent='Score:'+score;
        break;
      }
    }
  }
}

// ---------- Interactions ----------
function handleBlobInteractions(now){
  // normal blobs vs bullets
  for(let i=blobs.length-1;i>=0;i--){
    const b=blobs[i];
    for(let j=bullets.length-1;j>=0;j--){
      const bu=bullets[j];
      if(dist(b,bu)<b.radius){
        bullets.splice(j,1);
        if(b.radius>12){
          const n=2+Math.floor(Math.random()*3);
          for(let k=0;k<n;k++){
            const a=rnd(0,2*Math.PI), sp=rnd(1,3);
            const nb=createBlob(b.x,b.y,b.radius/2);
            nb.vx=Math.cos(a)*sp; nb.vy=Math.sin(a)*sp;
            blobs.push(nb);
          }
        }else{
          spawnExplosion(b.x,b.y,'cyan',20,1,4,50);
        }
        blobs.splice(i,1); score+=10; scoreEl.textContent='Score:'+score; break;
      }
    }
    // blob vs ship
    if(!invulnerable && !shieldActive && !initialShield && dist(b,ship)<b.radius+ship.radius){
      lives--; updateLivesDisplay(); shipExplosion(); shipRespawn();
    }
    // blob vs active shield -> soft push
    if((shieldActive||initialShield) && dist(b,ship)<b.radius+SHIELD_RADIUS){
      const dx=b.x-ship.x, dy=b.y-ship.y, len=Math.hypot(dx,dy), force=5;
      b.vx+=(dx/len)*force*0.2; b.vy+=(dy/len)*force*0.2;
    }
  }

  // Guardians: elastic rebound off shield ONLY (no particles, no flash, no shield flicker)
  for(const p of predatorBlobs){
    if((shieldActive||initialShield) && dist(p,ship)<p.radius+SHIELD_RADIUS){
      const dx=p.x-ship.x, dy=p.y-ship.y, len=Math.hypot(dx,dy);
      const nx=dx/len, ny=dy/len;
      const dot=p.vx*nx+p.vy*ny;
      // elastic reflection
      p.vx = p.vx - 2*dot*nx;
      p.vy = p.vy - 2*dot*ny;
      // speed-dependent boost
      const speed = Math.hypot(p.vx,p.vy);
      const boost = Math.min(3 + speed*0.15, 6);
      p.vx += nx*boost; p.vy += ny*boost;

      // GUARDIAN: bounce only — no effects
      // (removed spawnTrail and shieldFlicker; no p.flashTimer here)
    }
  }
}

// ---------- Shield activation ----------
function activateShield(){
  if(shieldUses>0 && !shieldActive){
    shieldActive=true; shieldUses--; shieldTimer=300; updateShieldDisplay();
  }
}

// ---------- Main loop ----------
function loop(){
  const now = Date.now();
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // dust
  for(const d of dusts){ ctx.beginPath(); ctx.arc(d.x,d.y,d.radius,0,Math.PI*2); ctx.fillStyle=`rgba(255,255,255,${d.alpha})`; ctx.fill(); }

  updateShip(now); drawShip();

  updateBullets();
  for(const b of bullets){ ctx.beginPath(); ctx.arc(b.x,b.y,4,0,Math.PI*2); ctx.fillStyle='lime'; ctx.fill(); }

  for(const b of blobs){ updateBlob(b); drawBlob(b, now); }
  handleBlobInteractions(now);

  for(const p of predatorBlobs){ updateBlob(p); drawBlob(p, now); }

  updateParticles(); drawParticles(now);

  drawShield(now);
  updateShieldPowerUps(); drawShieldPowerUps(now);
  checkShieldPowerUpHits(); drawShieldFragments(now);

  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
