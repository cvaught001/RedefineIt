<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Warp Waves ‚Äî Sound Reactive (Preset)</title>
    <style>
      :root {
        color-scheme: dark;
      }
      html,
      body {
        margin: 0;
        height: 100%;
        background: #0b0f13;
        overflow: hidden;
      }
      canvas {
        display: block;
        width: 100vw;
        height: 100vh;
      }
      .ui {
        position: fixed;
        left: 12px;
        top: 12px;
        z-index: 10;
        font: 14px/1.2 system-ui, sans-serif;
        color: #d9e7ff;
        background: rgba(10, 15, 24, 0.45);
        backdrop-filter: blur(6px);
        border: 1px solid rgba(120, 160, 220, 0.25);
        border-radius: 10px;
        padding: 10px 12px;
      }
      .ui button,
      .ui input[type='range'],
      .ui select {
        width: 220px;
        margin: 6px 0;
        padding: 10px 12px;
        background: #1a2330;
        border: 0;
        border-radius: 8px;
        color: #e6f0ff;
      }
      .row {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .ui label {
        opacity: 0.9;
      }
      .hint {
        opacity: 0.7;
        font-size: 12px;
        margin-top: 6px;
      }
      #jsonModal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(6px);
        z-index: 20;
        align-items: center;
        justify-content: center;
      }
      #jsonBox {
        background: #0e1520;
        color: #cde3ff;
        border: 1px solid #4a70b8;
        border-radius: 12px;
        padding: 20px;
        width: 80%;
        max-width: 600px;
      }
      #jsonBox textarea {
        width: 100%;
        height: 200px;
        background: #0b1018;
        color: #aee;
        border: 1px solid #335;
        border-radius: 8px;
        padding: 8px;
      }
      #jsonBox button {
        margin-top: 10px;
        padding: 8px 14px;
        border: 0;
        border-radius: 6px;
        background: #1a2330;
        color: #def;
      }
      #toggleUI {
        position: fixed;
        right: 12px;
        top: 12px;
        z-index: 15;
        font-size: 20px;
        line-height: 1;
        background: rgba(10, 15, 24, 0.45);
        border: 1px solid rgba(120, 160, 220, 0.25);
        color: #d9e7ff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        cursor: pointer;
        backdrop-filter: blur(6px);
        transition: background 0.2s, transform 0.2s, opacity 0.3s;
      }
      #toggleUI:hover {
        background: rgba(30, 45, 70, 0.6);
        transform: scale(1.1);
      }

      .ui {
        transition: opacity 0.35s ease, transform 0.35s ease;
        transform-origin: top left;
      }
      .ui.hidden {
        opacity: 0;
        transform: scale(0.9);
        pointer-events: none;
      }
    </style>
  </head>
  <body>
    <canvas id="c"></canvas>
    <button id="toggleUI" title="Toggle Controls">üëÅÔ∏è</button>

    <div class="ui">
      <button id="micBtn">Start Mic</button>
      <div class="row">
        <label for="rays">Rays</label
        ><input id="rays" type="range" min="1" max="10" value="1" />
      </div>
      <div class="row">
        <label for="sens">Sensitivity</label
        ><input id="sens" type="range" min="50" max="300" value="94" />
      </div>
      <div class="row">
        <label for="trail">Trail</label
        ><input id="trail" type="range" min="4" max="60" value="24" />
      </div>
      <div class="row">
        <label for="hue">Hue Shift</label
        ><input id="hue" type="range" min="0" max="360" value="36" />
      </div>

      <!-- üîΩ New preset dropdown -->
      <div class="row">
        <label for="presetSelect">Presets</label>
        <select id="presetSelect">
          <option value="default">Default</option>
          <option value="triple">3-Ray Neon</option>
        </select>
      </div>

      <button id="defaultPreset">‚≠ê Load Default Preset</button>
      <button id="randomize">üé≤ Randomize</button>
      <button id="save">üíæ Save Preset</button>
      <button id="load">üìÇ Load Preset</button>
      <div class="hint">Soft neon warp ‚Ä¢ starts with your saved preset</div>
    </div>

    <div id="jsonModal">
      <div id="jsonBox">
        <textarea id="jsonText"></textarea><br />
        <button id="applyJson">Apply</button>
        <button id="closeJson">Close</button>
      </div>
    </div>
    <script>
      ;(() => {
        const canvas = document.getElementById('c')
        const ctx = canvas.getContext('2d', { alpha: false })
        const buf = document.createElement('canvas')
        const bctx = buf.getContext('2d')

        // UI elements
        const micBtn = document.getElementById('micBtn')
        const rays = document.getElementById('rays')
        const sens = document.getElementById('sens')
        const trail = document.getElementById('trail')
        const hue = document.getElementById('hue')
        const randomBtn = document.getElementById('randomize')
        const saveBtn = document.getElementById('save')
        const loadBtn = document.getElementById('load')
        const modal = document.getElementById('jsonModal')
        const jsonText = document.getElementById('jsonText')
        const applyJson = document.getElementById('applyJson')
        const closeJson = document.getElementById('closeJson')
        const defaultBtn = document.getElementById('defaultPreset')
        const presetSelect = document.getElementById('presetSelect')

        // dynamic extra controls
        const ui = document.querySelector('.ui')
        ui.insertAdjacentHTML(
          'beforeend',
          `
    <div class="row"><label for="midGap">Mid Gap</label><input id="midGap" type="range" min="0" max="200" value="60"></div>
    <div class="row"><label for="edgy">Edginess</label><input id="edgy" type="range" min="1" max="10" value="3"></div>
    <div class="row"><label for="topBias">Top Bias</label><input id="topBias" type="range" min="-5" max="10" value="0"></div>
    <div class="row"><label for="angle">Angle¬∞</label><input id="angle" type="range" min="0" max="45" value="0"></div>
    <div class="row"><label>Symmetry</label><input id="symmetry" type="checkbox" checked></div>
    <div class="row"><label>Glow Pulse</label><input id="glowPulse" type="checkbox" checked></div>
    <div class="row"><label>Drift Motion</label><input id="driftMotion" type="checkbox" checked></div>
  `
        )

        const midGap = document.getElementById('midGap')
        const edgy = document.getElementById('edgy')
        const topBias = document.getElementById('topBias')
        const angleSlider = document.getElementById('angle')
        const symmetry = document.getElementById('symmetry')
        const glowPulse = document.getElementById('glowPulse')
        const driftMotion = document.getElementById('driftMotion')

        const presets = {
          default: {
            rays: 1,
            sens: 94,
            trail: 24,
            hue: 36,
            midGap: 60,
            edgy: 3,
            topBias: 0,
            angle: 0,
            symmetry: true,
            glowPulse: true,
            driftMotion: true
          },
          laser: {
            rays: 3,
            sens: 280,
            trail: 36,
            hue: 200,
            midGap: 90,
            edgy: 6,
            topBias: 2,
            angle: 20,
            symmetry: false,
            glowPulse: true,
            driftMotion: true
          }
        }

        let DPR = Math.min(2, devicePixelRatio || 1),
          W = 0,
          H = 0,
          CX = 0,
          CY = 0
        const resize = () => {
          W = canvas.width = innerWidth * DPR
          H = canvas.height = innerHeight * DPR
          buf.width = W
          buf.height = H
          CX = W / 2
          CY = H / 2
          ctx.fillStyle = '#0b0f13'
          ctx.fillRect(0, 0, W, H)
        }
        addEventListener('resize', resize, { passive: true })
        resize()

        // üé§ microphone input
        let audioCtx = null,
          analyser = null,
          stream = null
        const FFT = 1024
        let wave = new Uint8Array(FFT)
        async function startMic() {
          if (analyser) {
            stopMic(false)
            return
          }
          try {
            stream = await navigator.mediaDevices.getUserMedia({ audio: true })
            audioCtx = new (window.AudioContext || window.webkitAudioContext)()
            const src = audioCtx.createMediaStreamSource(stream)
            analyser = audioCtx.createAnalyser()
            analyser.fftSize = FFT * 2
            analyser.smoothingTimeConstant = 0.85
            src.connect(analyser)
            micBtn.textContent = 'Stop Mic'
          } catch {
            micBtn.textContent = 'Mic blocked'
            setTimeout(() => (micBtn.textContent = 'Start Mic'), 1500)
          }
        }
        function stopMic(update = true) {
          if (stream) stream.getTracks().forEach(t => t.stop())
          if (audioCtx) audioCtx.close()
          analyser = null
          audioCtx = null
          stream = null
          if (update) micBtn.textContent = 'Start Mic'
        }
        micBtn.onclick = startMic

        function gradientAt(y, a = 1) {
          const g = bctx.createLinearGradient(0, y - 80 * DPR, 0, y + 80 * DPR)
          const baseHue = +hue.value % 360
          g.addColorStop(0, `hsla(${baseHue + 60},100%,65%,0)`)
          g.addColorStop(0.5, `hsla(${baseHue},100%,70%,${a})`)
          g.addColorStop(1, `hsla(${baseHue - 60},100%,65%,0)`)
          return g
        }

        function drawFrame(t) {
          ctx.fillStyle = `rgba(11,15,19,${trail.value / 220})`
          ctx.fillRect(0, 0, W, H)

          if (analyser) analyser.getByteTimeDomainData(wave)
          else
            for (let i = 0; i < wave.length; i++) {
              const v =
                128 +
                60 * Math.sin(i * 0.04 + t * 2.2) +
                20 * Math.sin(i * 0.017 - t * 1.2)
              wave[i] = Math.max(0, Math.min(255, v))
            }

          let sum = 0
          for (let i = 0; i < wave.length; i++) {
            const d = wave[i] - 128
            sum += d * d
          }
          const rms = Math.sqrt(sum / wave.length) / 128
          const amp = (H * 0.08 + H * 0.3 * rms) * (+sens.value / 200)

          bctx.clearRect(0, 0, W, H)
          const step = Math.max(1, Math.floor(wave.length / (W / (2 * DPR))))
          const bands = 10 + Math.floor(+rays.value)
          const gap = 12 * DPR
          const baseHue = +hue.value % 360
          const theta = (+angleSlider.value * Math.PI) / 180
          const drift = driftMotion.checked ? Math.sin(t * 0.2) * 40 * DPR : 0

          function stroke(yBase, opacity = 1, edge = 1) {
            bctx.beginPath()
            for (let i = 0, x = 0; i < wave.length; i += step) {
              const v = (wave[i] - 128) / 128
              const wiggle =
                v * amp * 0.6 +
                Math.sin(i * 0.01 * edge + t * 1.8) * amp * 0.08 +
                Math.sin(i * 0.028 * edge - t * 1.4) * amp * 0.05
              const y = yBase + wiggle
              const rotX =
                (x - CX) * Math.cos(theta) - (y - CY) * Math.sin(theta) + CX
              const rotY =
                (x - CX) * Math.sin(theta) +
                (y - CY) * Math.cos(theta) +
                CY +
                drift
              if (x === 0) bctx.moveTo(rotX, rotY)
              else bctx.lineTo(rotX, rotY)
              x += step * (W / wave.length)
            }
            bctx.strokeStyle = gradientAt(yBase, opacity)
            bctx.lineWidth = 1.4 * DPR
            const glow = glowPulse.checked ? 0.5 + 1.2 * rms : 0.6
            bctx.shadowBlur = 10 * DPR * glow
            bctx.shadowColor = `hsla(${baseHue},100%,70%,${opacity * 0.6})`
            bctx.stroke()
          }

          const totalBands = bands + +topBias.value
          for (let i = -bands; i <= totalBands; i++) {
            if (!symmetry.checked && i < 0) continue
            const dist = Math.abs(i) / bands
            const fade = Math.pow(1 - dist, 1.5)
            const offset = i * gap + Math.sign(i) * +midGap.value
            stroke(CY + offset, fade * 0.9, +edgy.value)
          }

          const grad = ctx.createLinearGradient(0, 0, 0, H)
          grad.addColorStop(0, 'rgba(11,15,19,0.85)')
          grad.addColorStop(0.25, 'rgba(11,15,19,0)')
          grad.addColorStop(0.75, 'rgba(11,15,19,0)')
          grad.addColorStop(1, 'rgba(11,15,19,0.85)')
          ctx.globalCompositeOperation = 'source-over'
          ctx.drawImage(buf, 0, 0)
          ctx.fillStyle = grad
          ctx.fillRect(0, 0, W, H)
        }

        // helper utilities
        const getSettings = () => ({
          rays: +rays.value,
          sens: +sens.value,
          trail: +trail.value,
          hue: +hue.value,
          midGap: +midGap.value,
          edgy: +edgy.value,
          topBias: +topBias.value,
          angle: +angleSlider.value,
          symmetry: symmetry.checked,
          glowPulse: glowPulse.checked,
          driftMotion: driftMotion.checked
        })
        const applySettings = o => {
          for (const k in o) {
            const el = document.getElementById(k)
            if (!el) continue
            if (el.type === 'checkbox') el.checked = o[k]
            else el.value = o[k]
          }
        }

        // save/load/randomize
        saveBtn.onclick = () => {
          jsonText.value = JSON.stringify(getSettings(), null, 2)
          modal.style.display = 'flex'
        }
        loadBtn.onclick = () => {
          jsonText.value = ''
          modal.style.display = 'flex'
        }
        applyJson.onclick = () => {
          try {
            applySettings(JSON.parse(jsonText.value))
          } catch {
            alert('Invalid JSON')
          }
          modal.style.display = 'none'
        }
        closeJson.onclick = () => (modal.style.display = 'none')
        randomBtn.onclick = () => {
          rays.value = (1 + Math.random() * 8).toFixed(0)
          sens.value = (80 + Math.random() * 220).toFixed(0)
          trail.value = (8 + Math.random() * 40).toFixed(0)
          hue.value = (Math.random() * 360).toFixed(0)
          midGap.value = (20 + Math.random() * 120).toFixed(0)
          edgy.value = (1 + Math.random() * 9).toFixed(0)
          topBias.value = (-2 + Math.random() * 10).toFixed(0)
          angleSlider.value = (Math.random() * 45).toFixed(0)
          symmetry.checked = Math.random() > 0.5
          glowPulse.checked = Math.random() > 0.3
          driftMotion.checked = Math.random() > 0.5
        }

        defaultBtn.onclick = () => applySettings(presets.default)
        presetSelect.onchange = () => {
          const p = presets[presetSelect.value]
          if (p) applySettings(p)
        }

        function loop(ms) {
          drawFrame(ms * 0.001)
          requestAnimationFrame(loop)
        }
        requestAnimationFrame(loop)

        // üëÅÔ∏è UI Toggle
        const uiPanel = document.querySelector('.ui')
        const toggleUIBtn = document.getElementById('toggleUI')
        let uiVisible = true
        toggleUIBtn.onclick = () => {
          uiVisible = !uiVisible
          uiPanel.classList.toggle('hidden', !uiVisible)
          toggleUIBtn.textContent = uiVisible ? 'üëÅÔ∏è' : 'üôà'
          toggleUIBtn.title = uiVisible
            ? 'Hide Controls (H)'
            : 'Show Controls (H)'
        }
        document.addEventListener('keydown', e => {
          if (e.key.toLowerCase() === 'h') toggleUIBtn.click()
        })
      })()
    </script>
  </body>
</html>
